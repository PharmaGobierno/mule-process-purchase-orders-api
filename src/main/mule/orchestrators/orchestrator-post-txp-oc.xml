<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<sub-flow name="orchestrator-post-txp-oc-main" doc:id="aa3b6786-1120-400e-8800-5463298d7532" >
		<choice doc:name="Choice" doc:id="a08970f2-357a-484d-8b83-99e207ce9d5a">
				<when expression="#[vars.OC_number != null]">
				<flow-ref doc:name="Call to orchestrator-post-txp-oc-generate" doc:id="12ac0f39-bf6a-4eac-bfdc-302107f1abce" name="orchestrator-post-txp-oc-generate"/>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="53c5ccb4-063e-45e9-a539-dfbce500d5ed" message="Error al generar la OC"/>
			</otherwise>
			</choice>
	</sub-flow>
	<sub-flow name="orchestrator-post-txp-oc-generate" doc:id="e375e459-6dde-4c4c-abf3-d302656d370b" >
		<ee:transform doc:name="Split OC_Number" doc:id="02479156-a8f7-4e48-a8e5-47519af8df8d">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
vars.OC_number splitBy ("|")]]></ee:set-payload>
				</ee:message>
				<ee:variables>
					<ee:set-variable variableName="ocDMS"><![CDATA[%dw 2.0
output application/json
---
[]]]></ee:set-variable>
					<ee:set-variable variableName="migoDMS"><![CDATA[%dw 2.0
output application/json
---
[]]]></ee:set-variable>
				</ee:variables>
			</ee:transform>
			<foreach doc:name="For Each" doc:id="70e969dc-7e0b-4753-b645-16ac4db947e2" >
				<ee:transform doc:name="Split OC and MIGO" doc:id="b3a16a65-3a6e-4c1c-95f6-9ed5fd6c8fe0" >
					<ee:message >
						<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload splitBy(",")]]></ee:set-payload>
					</ee:message>
				</ee:transform>
				<choice doc:name="Choice" doc:id="d65eec84-566a-495d-80e8-44782d71fd4b" >
					<when expression='#[payload[0] != "" and payload[0] != null]'>
						<ee:transform doc:name="Save OC" doc:id="e67813a4-b9eb-448a-867f-d31362d1b8ce" >
							<ee:message >
							</ee:message>
							<ee:variables >
								<ee:set-variable variableName="ocDMS" ><![CDATA[%dw 2.0
output application/json
---
vars.ocDMS ++ [payload[0]]]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
					</when>
				</choice>
				<choice doc:name="Choice" doc:id="b2ac97cc-264f-4877-9fb1-99802dfd2904" >
					<when expression='#[payload[1] != "" and payload[1] != null]'>
						<ee:transform doc:name="Save MIGO" doc:id="20d8a1b3-23cc-48dd-8d11-da74b7246339" >
							<ee:message >
							</ee:message>
							<ee:variables >
								<ee:set-variable variableName="migoDMS" ><![CDATA[%dw 2.0
output application/json
---
vars.migoDMS ++ [payload[1]]]]></ee:set-variable>
							</ee:variables>
						</ee:transform>
					</when>
				</choice>
			</foreach>
		<ee:transform doc:name="Message to DMS" doc:id="e2a67e8a-5765-431c-a41a-ede64cf6edb4">
				<ee:message>
					<ee:set-payload><![CDATA[%dw 2.0
import * from dw::util::Timer
output application/json
---
{
    "id": "",
    "type": "blueyonder-load_oc_migo-created",
    "timestamp": currentMilliseconds(),
    "partition_key": vars.header_load.Load.system_load_id,
    "load": {
        "id": vars.header_load.Load.system_load_id,
        "oc": vars.ocDMS,
        "migo": vars.migoDMS
    }
}]]></ee:set-payload>
				</ee:message>
			</ee:transform>
		<logger level="INFO" doc:name="Logger" doc:id="65680397-e35e-4f76-a1ab-ec6bc8a38b00" message="#[payload]" />
		<flow-ref doc:name="clients_system-tms-mobile-main" doc:id="1fca5793-bd68-4355-bbc2-6cbd2f4e2fad" name="clients_system-tms-mobile-main" />
		<logger level="INFO" doc:name="Logger" doc:id="ae045bab-c1df-4ff2-b55d-fac170036378" message="#[payload]"/>
	</sub-flow>
</mule>
